<!doctype html>
<style>
button {
      width: 40px;
      height: 30px;
    }
p1 {
	padding: 5px 5px 0px 11px;
    font-size: 10pt;
    font-family: monospace;
    }
.tooltip {
      position: fixed;
      padding: 10px 20px;
      border: 1px solid #b3c9ce;
      border-radius: 4px;
      text-align: center;
      font: italic 14px/1.3 sans-serif;
      color: #333;
      background: #fff;
      box-shadow: 3px 3px 3px rgba(0, 0, 0, .3);
    }
</style>
<html>
     <head>
          <title>Get Cards Data</title>
     </head>
<div>Загрузить список</div>
<input type="file" id="load" onchange="loadBooks(this.files)"></input>
<div><textarea placeholder="" id="cards-list-id"></textarea></div>

     <script>
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            function loadBooks(files) {
                let file = files[0];
                let reader = new FileReader();
                document.getElementById("cards-list-id").value=""
                reader.readAsText(file);
                reader.onload = function() {
                    arr = reader.result.split('\n');
                    arr.forEach(function(item) {
                        item = item.trim();
                        if (item.length>0 && item.split('{').length>1) {
                            line = item.split(' ');
                            window.number = 1;
                            let lang = 'en';
                            let index = 0;
                            if (!isNaN(line[index][0].split('x')[0])) {
                                number = parseInt(line[0].split('x')[0]);
                                index = 1;
                            }
                            lang = line[index++].split('[')[1].split(']')[0];
                            set = line[index].split('{')[1].split('/')[0];
                            num = line[index].split('}')[0].split('/')[1];
                            getSetData(`https://api.scryfall.com/cards/${set}/${num}`);
                            //await sleep(30);
                        } else {
                            addLine(`${item}\n`);
                        }
                        });
                    }
                }

            function addLine(line) {
                let cards_list = document.getElementById("cards-list-id");
                cards_list.value += line;
            }

            function getSetData(rest_request) {
                fetch(rest_request)
                .then(response => {
                // indicates whether the response is successful (status code 200-299) or not
                if (!response.ok) {
                    throw new Error(`Request failed with status ${reponse.status}`)
                }
                return response.json()
                })
                .then(data => {
                let line = `${window.number}x ${data.name} ${parseInt(90*data.prices.usd)}\n`;
                addLine(line);
                var number = 0;
                if (data.has_more) {
                    console.log(data.next_page);
                     getSetData(data.next_page);
                }
                })
                .catch(error => console.log(error))
            }

            function main() {
                url_parameters = new URLSearchParams(window.location.search);
            }

            window.onload = main
      </script>  
     <body>
           
     </body>
</html>
